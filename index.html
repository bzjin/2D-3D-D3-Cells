<!DOCTYPE HTML>
<html lang="en">
	<head>
		<title>Body</title>
		<meta charset="utf-8">
		<style type="text/css">
			@font-face {
			  font-family: 'Effra';
			  src: url('fonts/Effra_Std_Rg.ttf');
			}

			@font-face {
			  font-family: 'Effra Heavy';
			  src: url('fonts/Effra_Std_He.ttf');
			}
			body { background-color: #000000; margin: 0px; overflow: hidden; font-family: "Effra";}
			a { color:#0078ff; }
			.slice {
			    border-radius: 100px;
			}
			div {
				padding: 20px;
				float: left;
			}
			text { font-size: 11px; }
			}
			.ticks {
			  font: 10px sans-serif;
			}

			.track,
			.track-inset,
			.track-overlay {
			  stroke-linecap: round;
			}

			.track {
			  stroke: white;
			  stroke-opacity: 0.3;
			  stroke-width: 10px;
			}

			.track-inset {
			  stroke: #ddd;
			  stroke-width: 8px;
			}

			.track-overlay {
			  pointer-events: stroke;
			  stroke-width: 50px;
			  stroke: transparent;
			  cursor: crosshair;
			}

			.handle {
			  fill: #fff;
			  stroke: white;
			  stroke-opacity: 0.5;
			  stroke-width: 1.25px;
			}
		</style>
	</head>
	<body>
		<!--<div id="svg"></div>-->
		<!--<div id="svgL"></div>-->
		<div id="canvasL"></div>
		<div id="scroller"></div>

		<div id="container"></div>
		<!-- D3 Library --> <script src="js/d3.v4.min.js"></script>
    	<!-- D3-Tip --> <script src="js/d3-tip.js"></script>
		<script type="text/javascript" src="js/three.min.js"></script>
		<script type="text/javascript" src="js/Detector.js"></script>
		<script type="text/javascript" src="js/TrackballControls.js"></script>
		<script type="text/javascript" src="js/CSS3DRenderer.js"></script>
		<script type="text/javascript" src="js/stats.min.js"></script>
    	<script type="text/javascript" src="https://cdn.rawgit.com/mrdoob/three.js/r69/examples/js/loaders/ColladaLoader.js"></script>

		<script type="text/javascript" src="js/RequestAnimationFrame.js"></script>

		<script type="text/javascript">

//init();

			window.onload = function() {
      			all_imgs = [];
      			for ( var i = 0; i <= 59; i++ ) {
	     				var imgurl = "";
						var preurl = "";
						if (i < 10){ 
							imgurl = 'slices/raw_000' + i + '.jpg'; 
							preurl = 'slices/pre_000' + i + '.jpg';}
						else { 
							imgurl = 'slices/raw_00' + i + '.jpg';
							preurl = 'slices/pre_00' + i + '.jpg';}

						make_base(imgurl);

						function make_base(imgurl) {
		     				base_image = new Image();
		     				base_image.src =  imgurl;
		     				var x = (i- (Math.floor(i/6)*6)) * 65;
		     				var y = Math.floor(i/6) * 75;

		     				base_image.onload = function(){
		     					all_imgs.push(base_image);
		     				}
	     				}
	     			}// end for loop
	     		//console.log(all_imgs)
      			window.setTimeout(drawImages, 500);


				var canvas = d3.select('#canvasL').append("canvas")
				.attr("id", "bigcanvas")
				.attr("width", 900)
				.attr("height", 800);
				
				var scroller = d3.select('#scroller').append("svg")
				.attr("id", "scroll")
				.attr("width", 240)
				.attr("height", 100);

			    var context = canvas.node().getContext("2d");
			    context.fillStyle =("white");

				context.font = "10px Effra";
				context.textAlign = "start"
				context.textBaseline = "hanging"

        		var svg = d3.select('#svg').append("svg")
        				.attr("width", 400)
     					.attr("height", 700)
     					.style("overflow", "visible");

     			var svgL = d3.select('#svgL').append("svg")
        				.attr("width", 220)
     					.attr("height", 700)
     					.style("overflow", "visible");

     			function drawImages() {
	     			for ( var i = 0; i <= 59; i++ ) {
	     				var imgurl = "";
						var preurl = "";
						if (i < 10){ 
							imgurl = 'slices/raw_000' + i + '.jpg'; 
							preurl = 'slices/pre_000' + i + '.jpg';}
						else { 
							imgurl = 'slices/raw_00' + i + '.jpg';
							preurl = 'slices/pre_00' + i + '.jpg';}

						make_base(imgurl);

						var color = d3.scaleLinear()
									.domain([0, .5, 1])
									.range(["#a50026","#d9ef8b","#006837"]);

						function hexToRgb(hex) {
						    var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
						    return result ? {
						        r: parseInt(result[1], 16),
						        g: parseInt(result[2], 16),
						        b: parseInt(result[3], 16)
						    } : null;
						}

						//alert( hexToRgb("#0033ff").g ); // "51";

						function make_base(imgurl) {
		     				base_image = new Image();
		     				base_image.src =  imgurl;
		     				var x = (i- (Math.floor(i/6)*6)) * 65;
		     				var y = Math.floor(i/6) * 75;

		     				//base_image.onload = function(){
		     					context.drawImage(base_image, x, y, 60, 60 )

		     					var imgData = context.getImageData(x, y, x+59, y+59);
		     					var allcolors = [];

			                    for (var k=0;k<imgData.data.length;k+=4){

			                    	var rgb_str = "(" + imgData.data[k] + "," + imgData.data[k+1] + "," + imgData.data[k+2] + ")";
									if (allcolors.indexOf(rgb_str) == -1){
									  	allcolors.push(rgb_str)
									}

								}
								allcolors.sort();
								//console.log(allcolors); //FOR THE DEMO. Shows how many colors and which ones are in each pixel

								for (var k=0;k<imgData.data.length;k+=4){
										var m = 30;
										//var c = d3.color();
										//console.log(d3.color(color(imgData.data[k]/255)))
										if (imgData.data[k] > (m+5) && imgData.data[k] < (m+10)){
									  		imgData.data[k]= 255; //red
									  		imgData.data[k+1]= 195; 
									    	imgData.data[k+2]= 0; 
									    } else if (imgData.data[k] > m && imgData.data[k] <= (m+5)) {
									  		imgData.data[k]= 255; //red
									  		imgData.data[k+1]= 87; 
									    	imgData.data[k+2]= 51; 
									    } else if (imgData.data[k] <= m && imgData.data[k] <= (m-5)){
									    	imgData.data[k]= 199; //red
									  		imgData.data[k+1]= 0; 
									    	imgData.data[k+2]= 255;
									    }
									  	//imgData.data[k+1]= imgData.data[k+1]; //green
									  	//imgData.data[k+2]= imgData.data[k+2]; //blue
									  /*else {
									  	imgData.data[k]=255-imgData.data[k]; //red
									  	imgData.data[k+1]=255-imgData.data[k+1]; //green
									  	imgData.data[k+2]=255-imgData.data[k+2]; //blue
									  //imgData.data[k+3]= 255-imgData.data[k+3];
									  }*/
									  
								}

								context.putImageData(imgData, x, y);	
		     				}
	     				


	     			}// end for loop
	     		}


				for ( var i = 0; i <= 59; i++ ) {
					var imgurl = "";
					var preurl = "";
					if (i < 10){ 
						imgurl = 'slices/raw_000' + i + '.jpg'; 
						preurl = 'slices/pre_000' + i + '.jpg';}
					else { 
						imgurl = 'slices/raw_00' + i + '.jpg';
						preurl = 'slices/pre_00' + i + '.jpg';}
                     
                    bigsq1 = new Image();
 					bigsq1.src =  'slices/raw_0059.jpg';
 					//context.drawImage(bigsq1, 0, 0, 200, 200 )
					var bigData = context.getImageData(0, 0, 200, 200);

					for (var k=0;k<bigData.data.length;k+=4){
						var m = 30;
						//var c = d3.color();
						//console.log(d3.color(color(bigData.data[k]/255)))
						if (bigData.data[k] > (m+5) && bigData.data[k] < (m+10)){
					  		bigData.data[k]= 255; //red
					  		bigData.data[k+1]= 195; 
					    	bigData.data[k+2]= 0; 
					    } else if (bigData.data[k] > m && bigData.data[k] <= (m+5)) {
					  		bigData.data[k]= 255; //red
					  		bigData.data[k+1]= 87; 
					    	bigData.data[k+2]= 51; 
					    } else if (bigData.data[k] <= m && bigData.data[k] <= (m-5)){
					    	bigData.data[k]= 199; //red
					  		bigData.data[k+1]= 0; 
					    	bigData.data[k+2]= 255;
					    }
					}
					context.putImageData(bigData, 0, 0);	
     				
/*
                    for (m = 0; m < 60; m++){
                    	for (n = 0; n < 60; n++){
                    		var col = context.getImageData(x + m, x+n,)
                    	}
                    }*/
                    
                     var imgurl = "github.com/bzjin/2D-3D-D3-Cells/slices/" + preurl + ".jpg";
                     var bigurl = "http://mkweb.bcgsc.ca/color-summarizer/?url=" + imgurl + "&precision=low&num_clusters=0&json=1";

                  } //end for loop for appending 60 images to the side
				

				context.beginPath();
				context.lineWidth="1";
				context.strokeStyle="white";
				context.rect(640,0,200,200); 
				context.stroke();

				context.fillText("Slice 1",845, 0);
				context.fillText("Slice 60",845, 190);

				//Slider
				var x = d3.scaleLinear()
				    .domain([0, 59])
				    .range([10, 210])
				    .clamp(true);

				var xInt = d3.scaleLinear()
				    .domain([0, 59])
				    .range([0, 59])
				    .clamp(true);

				var slider = scroller.append("g")
				    .attr("class", "slider")
				    .attr("transform", "translate(0, 720)")

				scroller.append("line")
				    .attr("class", "track")
				    .attr("x1", x.range()[0])
				    .attr("x2", x.range()[1])
				    .attr("y1", 20)
				    .attr("y2", 20)
				  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
				    .attr("class", "track-inset")
				  .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
				    .attr("class", "track-overlay")
				    .call(d3.drag()
				        .on("start.interrupt", function() { slider.interrupt(); })
				        .on("start drag", function() { hue(x.invert(d3.event.x)); }));

				scroller.insert("g", ".track-overlay")
				    .attr("class", "ticks")
				    .attr("transform", "translate(0," + 40 + ")")
				  .selectAll("text")
				  .data(x.ticks(10))
				  .enter().append("text")
				    .attr("x", x)
				    .style("fill", "white")
				    .attr("text-anchor", "middle")
				    .text(function(d) { return d});

				var handle = scroller.insert("circle", ".track-overlay")
				    .attr("class", "handle")
				    .attr("r", 9)
				    .attr("cx", x.range()[0])
				    .attr("cy", 20);

				/*canvas.node().addEventListener('mousedown', function(evt) {
			        var mousePos = getMousePos(canvas, evt);
			        var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
			        //writeMessage(canvas, message, mousePos.x, mousePos.y);
			      }, false);

				function writeMessage(canvas, message, x, y) {
			        context.clearRect(0, 0, canvas.width, canvas.height);
			        context.font = '18pt Calibri';
			        context.fillStyle = 'white';
			        context.fillText(message, x, y);
			      }*/

			      function getMousePos(canvas, evt) {
			        var rect = canvas.node().getBoundingClientRect();
			        //console.log(evt.clientX, evt.clientY);
			        return {
			        	x: (evt.clientX-rect.left)/(rect.right-rect.left)*900,
						y: (evt.clientY-rect.top)/(rect.bottom-rect.top)*800
			          //x: evt.clientX - rect.left,
			          //y: evt.clientY - rect.top
			        };
			      }

				function hue(h) {

				  handle.attr("cx", x(h));
				  var imgurlL = "", imgurlT = "", imgurlB = "";
				  
				  base = Math.floor(xInt(h));
				  
				  if (base < 10) { 
				  	imgurlT = 'slices/raw_000' + base + '.jpg';}
				  	//xzurl = 'slices/xz_000' + base + '.jpg';}
				  else { 
				  	imgurlT = 'slices/raw_00' + base + '.jpg';}
					//xzurl = 'slices/xz_00' + base + '.jpg';}

				  bigsq = new Image();
				  bigsq.src =  imgurlT;
				  context.drawImage(bigsq, 400, 0, 200, 200 )

				  
		     				 	  //bigSqData = context.getImageData(0, 0, 200, 200);
		     	  context.clearRect(605, 0, 30, 200);
		     	  context.fillRect(605, base/60*200, 30, 3);

				} //end hue

				canvas.node().addEventListener('mousedown', function(evt) {
			        var mousePos = getMousePos(canvas, evt);
			        //var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
			        drawScribble(mousePos.x, mousePos.y, base);
			      }, false);

				canvas.node().addEventListener('mouseover', function(evt) {
			        var mousePos = getMousePos(canvas, evt);
			        //var message = 'Mouse position: ' + mousePos.x + ',' + mousePos.y;
			        changeXZPlane(mousePos.x, mousePos.y, base);
			      }, false);

		 	  function drawScribble(xPos, yPos, zPos){
		 	  	  var xzurl = "";
		 	  	  var ySlice = Math.floor(yPos/200*60);

				  if (ySlice < 10) { 
				  	xzurl = 'slices/xz_000' + ySlice + '.jpg';}
				  else { 
					xzurl = 'slices/xz_00' + ySlice + '.jpg';}
		 	  	  

		 	  	  //console.log(xPos, yPos, zPos/60*200);
		 	  	  var radius = (200-yPos)/30;
		 	  	  //var zPos = base;
			      context.beginPath();
			      context.arc(xPos + 240, zPos/60*200, radius, 0, 2 * Math.PI, false);
			      context.fillStyle = 'yellow';
			      context.fill();

			      context.beginPath();
			      context.arc(xPos, yPos, 5, 0, 2 * Math.PI, false);
			      context.fill();
/*
			      context.beginPath();
			      context.arc(xPos + 240, zPos/60*200 + 210, 5, 0, 2 * Math.PI, false);
			      context.fillStyle = 'red';
			      context.fill();*/

			      context.fillStyle = 'white';

			      xzsq = new Image();
				  xzsq.src =  xzurl;

				  context.drawImage(xzsq, 640, 220, 200, 200);
		 	  }

		 	  function changeXZPlane(xPos, yPos, zPos){
		 	  	  var xzurl = "";
		 	  	  var ySlice = Math.floor(yPos/200*60);
				  if (ySlice < 10) { 
				  	xzurl = 'slices/xz_000' + ySlice + '.jpg';}
				  else { 
					xzurl = 'slices/xz_00' + ySlice + '.jpg';}
			      xzsq = new Image();

				  xzsq.src =  xzurl;

				  context.drawImage(xzsq, 640, 220, 200, 200);

		 	  }

}
/*
			var camera, scene, renderer;
			var scene2, renderer2;
			var controls;
			//init();
			//animate();

			function init() {
				camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 1, 1000 );
				camera.position.set( 200, 200, 200 );
				controls = new THREE.TrackballControls( camera );
				scene = new THREE.Scene();
				scene2 = new THREE.Scene();
				var material = new THREE.MeshBasicMaterial( { color: 0x000000, wireframe: true, wireframeLinewidth: 1, side: THREE.DoubleSide } );
				//
				for ( var i = 0; i < 10; i ++ ) {
					var element = document.createElement( 'div' );
					element.style.width = '100px';
					element.style.height = '100px';

					var iframe = document.createElement( 'iframe' );
						iframe.style.width = '100px';
						iframe.style.height = '100px';
						iframe.style.border = '0px';
						iframe.src = [ 'slices/raw_0059.jpg'].join( '' );
						element.appendChild( iframe );

					element.style.opacity = ( i < 5 ) ? 0.5 : 1;
					element.style.background = new THREE.Color( Math.random() * 0xffffff ).getStyle();
					var object = new THREE.CSS3DObject( element );
					//object.position.x = i * 20 - 100;
					object.position.y = i * 10;
					//object.position.z = i * 20  - 100;
					object.rotation.x = 90;
					/*object.rotation.y = Math.random();
					object.rotation.z = Math.random();
					object.scale.x = i/20 + 0.5;
					object.scale.y = i/20 + 0.5;
					scene2.add( object );
					var geometry = new THREE.PlaneGeometry( 100, 100 );
					var mesh = new THREE.Mesh( geometry, material );
					mesh.position.copy( object.position );
					mesh.rotation.copy( object.rotation );
					mesh.scale.copy( object.scale );
					scene.add( mesh );
				}
				//
				renderer = new THREE.WebGLRenderer();
				renderer.setClearColor( 0xf0f0f0 );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				document.body.appendChild( renderer.domElement );
				renderer2 = new THREE.CSS3DRenderer();
				renderer2.setSize( window.innerWidth, window.innerHeight );
				renderer2.domElement.style.position = 'absolute';
				renderer2.domElement.style.top = 0;
				document.body.appendChild( renderer2.domElement );
			}

			function animate() {
				requestAnimationFrame( animate );
				controls.update();
				renderer.render( scene, camera );
				renderer2.render( scene2, camera );
			}

*/

			

		</script>
	</body>
</html>
